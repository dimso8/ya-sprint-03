# Введение
Документ содержит архитектурное решение задачи спринта №3. Исходные требования описаны в разделе ниже.
## Цели бизнеса
### Промежуточное состояние (через пару месяцев)
- Описана AsIs и ToBe архитектура решения. Создан план по переходу к целевой системе.
- MVP с разделёнными микросервисами для управления отоплением, освещением, наблюдением, воротами.
### Финальное состояние (через год)
- Настроенные CI/CD пайплайны для автоматизации сборки и деплоя платформы экосистемы.
- Полностью развернутая экосистема умного дома с модульной структурой.
- Платформа экосистемы готова к подключению до 100 экопоселков по 200 домов по пять устройств в каждом.
- Пользователи могут самостоятельно подключать новые модули, управлять ими через интернет и настраивать автоматические сценарии работы устройств.

## Целевая экосистема, которую необходимо создать
- Экосистема доступна пользователю в режиме самообслуживания по модели SaaS.
- Система позволяет:
  - управлять отоплением;
  - включать и выключать свет;
  - запирать и отпирать автоматические ворота;
  - удаленно наблюдать за домом;
  - и будущее неуточненное поведение.
- Пользователь самостоятельно:
  - выбирает необходимые ему модули умного дома (устройства);
  - сам их подключает;
  - настраивает сценарии работы;
  - и просматривает телеметрию.
- Компания не занимается производством устройств, но поддерживает подключение к экосистеме устройств партнеров по стандартным протоколам.
- Веб-разработка передана на аутсорс и не входит в требования данной работы.

## Требования к экосистеме
- Модули управления приборами и сами приборы (устройства) должны быть максимально готовы к использованию и продаваться в отдельных комплектах для удобной покупки и подключения.
- Устройства должны быть доступны через интернет (для удаленного наблюдения и доступа), и предполагается, что пользователь будет иметь интернет-канал, к которому их можно подключить.
- Покупатели могут программировать систему для управления различными модулями в соответствии со своими потребностями.


# Disclaimer
> Предлагается использовать иной подход к интграции микросервисов и монолитного прложения: взаимодействие инициирует новый микросервис, а не монолитное приложение.
>
> Это лучше согласуется с паттерном Strangler Fig и не требует доработки монолитного приложения.


# Описание существующего решения
Приложение является монолитным, основные характеристики перечислены ниже:
- Язык программирования: Java
- База данных: PostgreSQL
- Архитектура: Монолитная, все компоненты системы (обработка запросов, бизнес-логика, работа с данными) находятся в рамках одного приложения.
- Взаимодействие: Синхронное, запросы обрабатываются последовательно.
- Масштабируемость: Ограничена, так как монолит сложно масштабировать по частям.
- Развертывание: Требует остановки всего приложения.

Основные функции приложения:
1. Управление отоплением:
   - Пользователи могут удалённо включать/выключать отопление в своих домах.
   - Пользователи могут устанавливать желаемую температуру.
   - Система автоматически поддерживает заданную температуру, регулируя подачу тепла.
2. Мониторинг температуры:
   - Система получает данные о температуре с датчиков, установленных в домах.
   - Пользователи могут просматривать текущую температуру в своих домах через веб-интерфейс.

## Контекстная диаграмма (as-is)
```puml
@startuml
!include ./diagrams/1-context/context-diagram-as-is.puml
@enduml
```
[Ссылка на файл с диаграммой](./diagrams/1-context/context-diagram-as-is.puml)

## Диаграмма контейнеров (as-is)
```puml
@startuml
!include ./diagrams/2-container/container-diagram-as-is.puml
@enduml
```
[Ссылка на файл с диаграммой](./diagrams/2-container/container-diagram-as-is.puml)

## Домены и контексты
1. **Управление устройствами.**
   1. _Контекст учета устройств._ Добавить, удалить, заменить и т.п.
   3. _Актуальное состояния устройств._ Открыто, закрыто, температура и т.п.
   4. _Правила управления._ Сценарии формирования команд, например, если параметр вышел за пределы значений
3. **Сбор и хранение телеметрии.** Получение и хранение показаний от датчиков умного дома. Фильтрация показаний. Передача показаний для формирования управляющих воздействий.
   1. *Контекст обработки в реальном времени.* Обработка потока от датчиков. Сбор телеметрии с датчиков.
   5. *Исторический контекст.* Исторические данные и работа с ними.
6. **Интеграция с внешними устройствами.**
   1. _Фильтрация, перекодировка сообщений из/во внутренний формат, передача сообщений от/к устройствам умного дома._
7. **Управление пользователями.**

# План развития архитектуры приложения
В связи с ростом нагрузки предлагается перейти на микросервисную архитектуру, и разделив монолитное приложение на функциональные блоки, соответствующие доменам выше.

В качестве MVP предлагается выделить два домена: "Управление устройствами" и "Сбор и хранение телеметрии", под которые будут созданы отдельные микросервисы.
Интеграция с монолитным приложением будет осуществляться с помощью REST.

Переход на микросервисную архитектуру планируется выполнять постепенно, используя паттерн Strangler Fig. Роль фасада будет выполнять новый микросервис device-manager, который будет перенаправлять запросы на управление системами отопления в монолитное приложение. 

Для обратной совместимости со старыми версиями клиентских приложений в сервисе device-manager будут сохранены методы управления системами отопления, которые будут помечены как устаревшие.

Все новые типы устройств будут добавлять в два новых сервиса. В старом приложении останется только управление системами отопления.

По мере развития приложения, роль монолита будет уменьшаться и его функции "переедут" в микросервисы. В итоге полностью откажемся от монолита и выведем его из эксплуатации.


## Контекстная диаграмма (to-be)
```puml
@startuml
!include ./diagrams/1-context/context-diagram-to-be.puml
@enduml
```
[Ссылка на файл с диаграммой](./diagrams/1-context/context-diagram-to-be.puml)

# Описание MVP
## Диаграмма контейнеров (MVP)
```puml
@startuml
!include ./diagrams/2-container/container-diagram-mvp.puml
@enduml
```
[Ссылка на файл с диаграммой](./diagrams/2-container/container-diagram-mvp.puml)

## Диаграммы компонентов
### Сервис управления устройствами
```puml
@startuml
!include ./diagrams/3-component/component-diagram-device-manager.puml
@enduml
```
[Ссылка на файл с диаграммой](./diagrams/3-component/component-diagram-device-manager.puml)

### Сервис телеметрии
```puml
@startuml
!include ./diagrams/3-component/component-diagram-device-telemetry.puml
@enduml
```
[Ссылка на файл с диаграммой](./diagrams/3-component/component-diagram-device-telemetry.puml)

## Диаграмма кода
```puml
@startuml
!include ./diagrams/4-code/code-diagram-device-manager.puml
@enduml
```
[Ссылка на файл с диаграммой](./diagrams/4-code/code-diagram-device-manager.puml)

## ER-диаграмма
```puml
@startuml
!include ./diagrams/4-code/code-diagram-device-manager.puml
@enduml
```
[Ссылка на файл с диаграммой](./diagrams/5-ER/er-diagram.puml)